<!DOCTYPE html>
<html>
  <head>
    <title>homeFM</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./resources/css/pure.css" />
    <link rel="stylesheet" href="./resources/css/pure-button.css" />
    <link rel="stylesheet" href="./resources/css/pure-tables.css" />
    <link rel="stylesheet" href="./resources/css/pure-forms.css" />
  </head>
  <body style="padding: 5px;">
    <h1>homeFM</h1>
    <div id="info_area">

    </div>
    <div id="main_content">
      <table class="pure-table pure-table-striped" id="playlist_overview">
        <thead>
          <tr>
            <th>&nbsp;</th>
            <th>Playlists</th>
          </tr>
        </thead>
      </table>
    </div>
    <div id="sub_content" style="margin: 10px;">
      <button class="pure-button" onclick="startFileWalker();" style="margin-right:5px;">start fileWalker</button>
      <button class="pure-button" onclick="stopServer();" style="margin-right:5px;">stop the server</button>
    </div>

    <script type="text/javascript">
      var loc = document.location;
      var restBaseUrl = loc.protocol + "//" + loc.host + "/rest/";

      checkServer();
      fillPlaylistOverview();

      function fillPlaylistOverview() {
        var playlistUrl = restBaseUrl + "get_playlists";
        var req = new XMLHttpRequest();
        req.open('GET', playlistUrl, false);
        req.send();
        var playlists = JSON.parse(req.responseText);
        var table = document.getElementById('playlist_overview');
        if (playlists.length === 0) {
          var tr = document.createElement('tr');
          var td = document.createElement('td');
          td.textContent = 'no playlists found :(';
          td.colSpan = '2';
          tr.appendChild(td);
          table.appendChild(tr);
          return;
        }

        for (var n = 0; n < playlists.length; n++) {
          var playlist = playlists[n];

          var tr = document.createElement('tr');
          var td1 = document.createElement('td');
          td1.textContent = playlist.id;
          var td2 = document.createElement('td');
          td2.onclick = function () {
            showPlaylist(this.playlistId);
          };
          td2.playlistId = playlist.id;
          td2.textContent = playlist.name;
          tr.appendChild(td1);
          tr.appendChild(td2);
          table.appendChild(tr);
        }
      }

      function showPlaylist(playlistId) {
        var songsForPlaylistUrl = restBaseUrl + "get_songs_for_playlist/" + playlistId;
        var req = new XMLHttpRequest();
        req.open('GET', songsForPlaylistUrl, false);
        req.send();
        var songs = JSON.parse(req.responseText);
        var summaries = [];
        for(var n=0; n<songs.length;n++) {
          var song=songs[n];
          summaries.push(song.artist + " - " + song.title);
        }
        alert(summaries);
      }

      function startFileWalker() {
        var fileWalkerUrl = restBaseUrl + "scan_files";
        var req = new XMLHttpRequest();
        req.open('GET', fileWalkerUrl, false);
        req.send();
        alert(req.responseText);
      }

      function checkServer() {
        var infoArea = document.getElementById('info_area');
        var hiUrl = restBaseUrl + 'hello';

        clearNode(infoArea);
        var req = new XMLHttpRequest();
        req.open('GET', hiUrl, false);
        req.send();

        var info = document.createElement('span');
        if ('hi' === req.responseText) {
          info.style.color = 'green';
          info.textContent = 'Server online';
        }
        infoArea.appendChild(info);
      }

      function stopServer() {
        var stopUrl = restBaseUrl + 'stop';

        var req = new XMLHttpRequest();
        req.open('GET', stopUrl, false);
        req.send();

        setTimeout(checkServer, 6000);
      }

      function clearNode(node) {
        while (node.firstChild) {
          node.removeChild(node.firstChild);
        }
      }
    </script>
  </body>
</html>
